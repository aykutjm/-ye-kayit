<!-- ... existing code ... -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // Public Key'iniz doğru şekilde eklendi.
            emailjs.init("NbbaYwpyVIocsaTaw"); 
        })();
    </script>
    <style>
<!-- ... existing code ... -->
    // PDF Oluşturma, Gönderme ve İndirme Fonksiyonu (GÜNCELLENDİ)
    async function generateAndSendPDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        // ... PDF oluşturma kodları aynı kalacak ...
        const page_margin = 50;
        const line_height = 15;
        const page_width = doc.internal.pageSize.getWidth();
        let yPos = page_margin;

        function addText(text, options = {}) {
            const splitText = doc.splitTextToSize(text, page_width - page_margin * 2);
            doc.setFont(options.font || 'helvetica', options.style || 'normal');
            doc.setFontSize(options.size || 10);
            doc.text(splitText, page_margin, yPos);
            yPos += (splitText.length * line_height);
            if (yPos > doc.internal.pageSize.getHeight() - page_margin) {
                doc.addPage();
                yPos = page_margin;
            }
        }
        
        addText('ÜYELİK SÖZLEŞMESİ', { size: 16, style: 'bold' });
        yPos += line_height;
        addText('1-) TARAFLAR', { style: 'bold' });
        addText('A-KULÜP', { style: 'bold' });
        addText('Adı-Soyadı : Aykut YILDIRIM\nÜnvanı : Atakum Tenis\nAdres : Derecik Mahallesi 1444. Sokak No:1 İlkadım/Samsun\nVergi No : 9540639540\nTelefon : 0544 936 75 43\nE-mail : y.aykut7455@gmail.com');
        yPos += line_height;
        addText('B-ÜYE/VELİ', { style: 'bold' });
        addText(`Adı-Soyadı : ${data.fullName}\nAdres : ${data.address}\nTCKN : ${data.tcno}\nTelefon : ${data.phone}\nE-mail : ${data.email}`);
        yPos += line_height;
        addText("İşbu sözleşmede bundan sonra “ÜYE/VELİ” olarak anılacaktır. Üye ve varsa veliye ait bilgiler yukarıda yer alan kısma ayrı ayrı yazılarak doldurulacaktır. Üye/Veli işbu sözleşmeyi onaylaması sırasında Eğitmen tarafından kendisinden talep edilen her türlü bilgiyi eksiksiz ve doğru olarak Eğitmene vermeyi kabul etmektedir. Üye/Veli, eğitimler sırasında Eğitmene bildirdiği bilgilerin doğruluğundan bizzat sorumludur.", {size: 8});
        yPos += line_height;
        if (data.isMinorCheck === 'on') {
            addText('REŞİT OLMAYAN ÜYE BEYANI', { style: 'bold' });
            addText(`-Reşit olmayan katılımcının velisi olarak, aşağıda bilgileri bulunan katılımcı adına sözleşmeyi kabul ettiğimi beyan ederim.`);
            addText(`Reşit Olmayanın Adı ve Soyadı: ${data.minorFullName}`);
            addText(`Reşit Olmayanın Doğum Tarihi: ${data.minorDob}`);
            addText(`Velisinin/Vasisinin Adı ve Soyadı: ${data.fullName}`);
            yPos += line_height;
        }
        addText('ONAY VE İMZA', { style: 'bold' });
        addText('Yukarıdaki sözleşme metnini okuduğumu, anladığımı ve tüm şartları kabul ettiğimi beyan ederim.');
        const timestamp = new Date().toLocaleString('tr-TR');
        addText(`İmza Tarihi ve Zaman Damgası: ${timestamp}`);
        yPos += line_height;
        const signatureData = canvas.toDataURL();
        doc.addImage(signatureData, 'PNG', page_margin, yPos, 160, 60);

        // --- PDF GÖNDERME VE İNDİRME ---
        const pdfBase64 = doc.output('datauristring').split(',')[1];
        
        // E-posta şablonları için ortak parametreler
        const templateParams = {
            ...data, // Formdaki tüm veriler
            timestamp: timestamp,
            attachment: pdfBase64,
            pdf_name: `${data.fullName.replace(/ /g, '_')}_sozlesme.pdf`
        };

        // 1. E-POSTA: PATRONA BİLDİRİM GÖNDER
        const sendToOwner = emailjs.send('service_h1se4bu', 'template_jg5fd9k', templateParams);

        // 2. E-POSTA: ÜYEYE ONAY VE PDF GÖNDER
        const sendToMember = emailjs.send('service_h1se4bu', 'template_0hvk6dg', templateParams);

        // Her iki e-postanın da gönderilmesini bekle
        await Promise.all([sendToOwner, sendToMember]);

        console.log("Patrona ve üyeye e-postalar başarıyla gönderildi!");

        // Son olarak PDF'i kullanıcıya indir
        doc.save(`${data.fullName.replace(/ /g, '_')}_uyelik_sozlesmesi.pdf`);
    }
</script>
</body>
