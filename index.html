<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spor Kul√ºb√º - √úyelik S√∂zle≈ümesi</title>
    <!-- Gerekli K√ºt√ºphaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCytn56Jwtf2tOnftW8MjUtLoH3PgGQnqU",
            authDomain: "uyekayit-5964b.firebaseapp.com",
            projectId: "uyekayit-5964b",
            storageBucket: "uyekayit-5964b.appspot.com",
            messagingSenderId: "493041591853",
            appId: "1:493041591853:web:939cb6494e8469ad133aa4"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firebase = { collection, addDoc, getDocs, updateDoc, doc, query, where };
    </script>
    
    <style>
        :root {
            --primary-color: #0891b2; /* Canlƒ± Camg√∂beƒüi */
            --secondary-color: #7c3aed; /* Canlƒ± Mor */
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e0e7ff 100%); /* A√ßƒ±k ve modern arkaplan */
            min-height: 100vh; 
            padding: 20px; 
            color: #333; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            max-width: 900px; 
            width: 100%;
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(45deg, var(--primary-color) 0%, var(--secondary-color) 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .form-container { padding: 30px 40px; }
        
        #progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        #progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 4px; width: 100%; background-color: var(--border-color); z-index: 1; }
        #progress-line { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 4px; background-color: var(--primary-color); z-index: 2; width: 0%; transition: width 0.3s ease; }
        .progress-step { position: relative; z-index: 3; width: 30px; height: 30px; background-color: white; border: 3px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--border-color); transition: all 0.3s ease; }
        .progress-step.active { border-color: var(--primary-color); background-color: var(--primary-color); color: white; }

        .form-step { display: none; }
        .form-step.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { font-size: 1.5em; color: var(--dark-color); margin-bottom: 25px; text-align: center; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; font-size: 0.95em; }
        input, select, textarea { padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 1em; transition: all 0.3s ease; width: 100%; background-color: var(--light-color); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2); }
        
        .contract-text { background: white; padding: 25px; border-radius: 10px; border: 2px solid var(--border-color); height: 350px; overflow-y: auto; font-size: 0.85em; line-height: 1.6; }
        .signature-section { background: var(--light-color); border-radius: 15px; padding: 30px; text-align: center; }
        .signature-canvas { border: 2px solid var(--border-color); border-radius: 10px; cursor: crosshair; display: block; margin: 20px auto; max-width: 100%; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .form-navigation { display: flex; justify-content: space-between; margin-top: 30px; }
        
        .checkbox-group { display: flex; align-items: flex-start; gap: 15px; margin: 20px 0; }
        .checkbox-group input { width: 20px; height: 20px; margin-top: 3px; flex-shrink: 0;}
        
        .alert { padding: 15px; border-radius: 8px; border: 1px solid transparent; margin-bottom: 20px; text-align: center; }
        .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }

        #pre-reg-not-found { display: none; }
        #paymentPlanContainer { display: none; padding: 25px; border-radius: 15px; background: var(--light-color); border-left: 5px solid var(--primary-color); }
        .payment-schedule { margin-top: 15px; }
        .payment-item-preview { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 5px; margin-bottom: 5px; border: 1px solid var(--border-color); }
        
        .admin-link { position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 10px 15px; border-radius: 25px; text-decoration: none; color: var(--dark-color); font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; backdrop-filter: blur(10px); z-index: 100; }
        .admin-link:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }

        #step-1 {
            background-color: #f0f5ff; /* A√ßƒ±k mavi tonu */
            border: 1px solid #dde8ff;
            border-radius: 15px;
            padding: 25px;
        }
        #successMessage {
            padding: 50px 20px;
            min-height: 450px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #successMessage h3 {
            font-size: 1.8em;
            color: var(--success-color);
        }
    </style>
</head>
<body>
    <a href="admin.html" class="admin-link">üè¢ Admin Panel</a>
    
    <div class="container" id="main-container">
        <div class="header">
            <h1 id="clubNameHeader">Atakum Tenis Kul√ºb√º - Mafen Spor Kul√ºb√º</h1>
            <p>Online √úyelik S√∂zle≈ümesi</p>
        </div>
        <div class="form-container">
            <div id="progress-bar">
                <div class="progress-step active" data-step="1">1</div>
                <div class="progress-step" data-step="2">2</div>
                <div class="progress-step" data-step="3">3</div>
                <div class="progress-step" data-step="4">4</div>
                <div id="progress-line"></div>
            </div>

            <form id="membershipForm">
                <!-- Step 1: Pre-registration Check -->
                <div class="form-step active" id="step-1">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="branchSelection">Bran≈ü Se√ßimi *</label>
                            <select id="branchSelection" required>
                                <option value="">Se√ßiniz...</option>
                                <option value="tenis">üéæ Tenis</option>
                                <option value="yuzme">üèä Y√ºzme</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phone">Telefon Numaranƒ±z *</label>
                            <input type="tel" id="phone" required placeholder="Sistemdeki √∂n kayƒ±tƒ±nƒ±zƒ± bulmak i√ßin l√ºtfen telefon numarasƒ± giriniz" pattern="0[0-g]{10}" maxlength="11" title="Telefon numarasƒ± 0 ile ba≈ülamalƒ± ve 11 haneli olmalƒ±dƒ±r.">
                        </div>
                    </div>
                    <div id="pre-reg-not-found" class="alert alert-danger" style="margin-top: 20px;">
                        <strong>√ñn kayƒ±tƒ±nƒ±z bulunmamaktadƒ±r.</strong> L√ºtfen ileti≈üime ge√ßiniz: 0362 363 00 64
                    </div>
                </div>

                <!-- Step 2: Information and Payment Plan -->
                <div class="form-step" id="step-2">
                     <h3 class="section-title">Kayƒ±t Bilgileri ve Aidat Bilgileriniz</h3>
                     <div id="paymentPlanContainer"></div>
                </div>

                <!-- Step 3: Veli / √úye Bilgileri -->
                <div class="form-step" id="step-3">
                    <h3 class="section-title">Ki≈üisel Bilgiler</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="fullName">Ad Soyad (Veli/√úye) *</label><input type="text" id="fullName" name="Ad_Soyad" required readonly></div>
                        <div class="form-group"><label for="tcno">T.C. Kimlik No *</label><input type="text" id="tcno" name="TC_Kimlik_No" pattern="[0-9]{11}" maxlength="11" required></div>
                         <div class="form-group"><label for="address">Adres *</label><textarea id="address" name="Adres" rows="3" required></textarea></div>
                    </div>
                    <div id="minorFields" style="margin-top: 20px; display: none;">
                        <div class="form-grid">
                            <div class="form-group"><label for="minorFullName">√ñƒürenci Adƒ± Soyadƒ± *</label><input type="text" id="minorFullName" name="Resit_Olmayan_Adi_Soyadi"></div>
                            <div class="form-group"><label for="minorDob">√ñƒürenci Doƒüum Tarihi *</label><input type="date" id="minorDob" name="Resit_Olmayan_Dogum_Tarihi"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Contract and Signature -->
                <div class="form-step" id="step-4">
                     <h3 class="section-title">S√∂zle≈üme ve ƒ∞mza</h3>
                     <div class="checkbox-group">
                        <input type="checkbox" id="cancellationPolicyNew" name="CancellationPolicyNew" required>
                        <label for="cancellationPolicyNew">√úyeliƒüiniz iptal edilene kadar devam etmektedir. Her ayƒ±n 14‚Äô√º, yeni d√∂nem i√ßin kayƒ±t iptali yapƒ±labilecek son g√ºnd√ºr. Bu tarihe kadar iptal edilmeyen kayƒ±tlar, devam eden d√∂nem i√ßin ge√ßerli sayƒ±lƒ±r.</label>
                    </div>
                     <div class="contract-text" id="contractTextArea"></div>
                     <div class="checkbox-group">
                        <input type="checkbox" id="agreeContract" name="Sozlesme_Onayi" value="Kabul Edildi" required>
                        <label for="agreeContract">√úyelik s√∂zle≈ümesini okudum, anladƒ±m ve kabul ediyorum. *</label>
                    </div>
                    <div class="signature-section">
                        <p>L√ºtfen a≈üaƒüƒ±daki alana imzanƒ±zƒ± atƒ±n:</p>
                        <canvas id="signatureCanvas" class="signature-canvas" width="400" height="200"></canvas>
                        <div><button type="button" class="btn btn-secondary" onclick="clearSignature()">ƒ∞mzayƒ± Temizle</button></div>
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Geri</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">ƒ∞leri</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">S√∂zle≈ümeyi Onayla</button>
                </div>
                 <!-- Ba≈üarƒ± mesajƒ± formun i√ßine ta≈üƒ±ndƒ± -->
                 <div id="successMessage" class="alert alert-success">
                     <h3>üéâ √úyeliƒüiniz Tamamlandƒ±!</h3>
                     <p>√úyelik s√∂zle≈ümeniz kul√ºb√ºm√ºze ba≈üarƒ±yla ula≈ümƒ±≈ütƒ±r. Ailemize katƒ±ldƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr eder, keyifli bir spor yolculuƒüu dileriz.</p>
                 </div>
            </form>
        </div>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    let currentStep = 1;
    let totalSteps = 4;
    let currentPreRegistration = null;
    
    // --- DOM ELEMENTS ---
    const steps = document.querySelectorAll(".form-step");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById('membershipForm');

    // --- CLUB & CONTRACT DATA ---
    const clubData = {
        tenis: { name: "Atakum Tenis Kul√ºb√º", icon: "üéæ", officialName: "Atakum Tenis", contactName: "Aykut YILDIRIM", address: "Derecik Mahallesi 1444. Sokak No:1 ƒ∞lkadƒ±m/Samsun", taxNo: "9540639540", phone: "0544 936 75 43", email: "y.aykut7455@gmail.com" },
        yuzme: { name: "Mafen Spor Kul√ºb√º", icon: "üèä", officialName: "Mafen Spor Kul√ºb√º", contactName: "Aykut YILDIRIM", address: "Derecik Mahallesi 1444. Sokak No:1 ƒ∞lkadƒ±m/Samsun", taxNo: "9540639540", phone: "0544 936 75 43", email: "y.aykut7455@gmail.com" }
    };

    function generatePaymentTableForPdf(schedule) {
        if (!schedule || schedule.length === 0) return '';
        
        let tableHtml = `
        <p><strong>Aidat Takvimi:</strong></p>
        <table style="width: 100%; border-collapse: collapse; font-size: 8px; margin-top: 10px; page-break-inside: avoid;">
            <thead style="background-color: #f2f2f2;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">D√∂nem</th>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">Tarih Aralƒ±ƒüƒ±</th>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">Tutar</th>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">Son √ñdeme</th>
                </tr>
            </thead>
            <tbody>
    `;

        schedule.forEach(p => {
            tableHtml += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 4px;">${p.paymentNumber}. Aidat</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${formatDate(p.period.start)} - ${formatDate(p.period.end)}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${p.amount}‚Ç∫</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${formatDate(p.dueDate)}</td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        return tableHtml;
    }
    
     const getContractSections = (club, data = {}, schedule = []) => {
        const { Ad_Soyad = '[Doldurulacak]', Adres = '[Doldurulacak]', TC_Kimlik_No = '[Doldurulacak]', Telefon = '[Doldurulacak]' } = data;
        const isChild = data.Resit_Olmayan_Adi_Soyadi;
        
        const part1 = `<h4>√úYELƒ∞K S√ñZLE≈ûMESƒ∞</h4>
        <p><strong>1-) TARAFLAR</strong><br>
        <strong>A-KUL√úP</strong><br>
        Adƒ±-Soyadƒ± : ${club.contactName}<br>
        √únvanƒ± : ${club.officialName}<br>
        Adres : ${club.address}<br>
        Vergi No : ${club.taxNo}<br>
        Telefon : ${club.phone}<br>
        E-mail : ${club.email}<br>
        Bu s√∂zle≈ümede bundan sonra "Eƒûƒ∞TMEN/KUL√úP" olarak anƒ±lacaktƒ±r.<br>
        <strong>B-√úYE/VELƒ∞</strong><br>
        Adƒ±-Soyadƒ± : ${Ad_Soyad}<br>
        Adres : ${Adres}<br>
        TCKN : ${TC_Kimlik_No}<br>
        Telefon : ${Telefon}<br>
        Bu s√∂zle≈ümede bundan sonra "√úYE/VELƒ∞" olarak anƒ±lacaktƒ±r. √úye ve varsa veliye ait bilgiler yukarƒ±da yer alan kƒ±sma ayrƒ± ayrƒ± yazƒ±larak doldurulacaktƒ±r.</p>
        <p>√úye/Veli i≈übu s√∂zle≈ümeyi onaylamasƒ± sƒ±rasƒ±nda Eƒüitmen tarafƒ±ndan kendisinden talep edilen her t√ºrl√º bilgiyi eksiksiz ve doƒüru olarak Eƒüitmene vermeyi kabul etmektedir. √úye/Veli, eƒüitimler sƒ±rasƒ±nda Eƒüitmene bildirdiƒüi bilgilerin doƒüruluƒüundan bizzat sorumludur.</p>
        <p>√úye/Veli, i≈übu s√∂zle≈ümeye onayƒ± esnasƒ±nda beyan etmi≈ü olduƒüu cep telefonu numarasƒ± ve e-posta adresinin Eƒüitmen tarafƒ±ndan yapƒ±lacak her t√ºrl√º bildirim i√ßin ge√ßerli tebligat mecralarƒ± sayƒ±lacaƒüƒ±nƒ±, bu cep telefonu numarasƒ± ve e-posta adresinin kullanƒ±mƒ± ile ilgili her t√ºrl√º yetkinin kendisinde olduƒüunu, ilgili cep telefonu numarasƒ± ve e-posta adresinin 3. ki≈üiler tarafƒ±ndan kullanƒ±ldƒ±ƒüƒ± ≈ü√ºphesinin varlƒ±ƒüƒ± halinde bu durumu ve her halde cep telefonu numarasƒ± ve e-posta adresinde meydana gelen deƒüi≈üiklikleri Eƒüitmene bildirmekle y√ºk√ºml√º olduƒüunu kabul ve taahh√ºt eder.</p>`;
        
        const part2 = `<p><strong>2-) KONU</strong><br>
        ƒ∞≈übu √ºyelik s√∂zle≈ümesi, √ºyelik i≈ülemlerinin ger√ßekle≈ütirilmesi ile i≈übu s√∂zle≈ümenin onaylanmasƒ± suretiyle, Eƒüitmen tarafƒ±ndan sunulacak hizmetin ≈üartlarƒ±nƒ± ve taraflarƒ±n kar≈üƒ±lƒ±klƒ± hak ve y√ºk√ºml√ºl√ºklerini d√ºzenlemektedir.</p>
        <p><strong>3-) S√úRE</strong><br>
        S√∂zle≈üme s√ºresi aylƒ±k ve 6 aylƒ±k periyotlar halinde d√ºzenlenmekte olup; kayƒ±tlar s√∂zle≈ümenin biteceƒüi ayƒ±n 15'inden √∂nce iptal edilmediƒüi takdirde aylƒ±k veya 6 aylƒ±k olarak uzatƒ±lmƒ±≈ü sayƒ±lmaktadƒ±r. Kayƒ±t silinmediƒüi takdirde yeni d√∂neme ili≈ükin √ºcret √úye/Veli tarafƒ±ndan kul√ºbe √∂denecektir.</p>
        <p><strong>4-) √úCRET</strong><br>
        √úyelik bedeli, √úyelik satƒ±≈ü formunda belirtilen √ºyelik paketine g√∂re .... Ay, aylƒ±k.. TL olup; i≈übu bedel √úye/Veli tarafƒ±ndan √∂denecektir.</p>
        <p><strong>5-) √ñDEMELER</strong><br>
        √ñdemelerin her ayƒ±n 20'sine kadar belirtilen hesaba yapƒ±lmasƒ± gerekmektedir. D√∂nem tarihlerine g√∂re eksik ya da fazla √∂deme durumu olu≈üabilir. √ñdemelerin zamanƒ±nda yapƒ±lmamasƒ± durumunda; √úye/Veli, yapacaƒüƒ± √∂demenin %25'i tutarƒ±nda cezai ≈üart √∂demeyi kabul ve taahh√ºt eder.</p>
        <p>Yapƒ±lan √∂demeler, derslere katƒ±lƒ±m taahh√ºd√º olarak kabul edilir. √úyenin derslere katƒ±lamamasƒ± sebebiyle √ºcret iadesi yapƒ±lmaz.</p>
        <p><strong>6-) √úYELƒ∞K ƒ∞PTALLERƒ∞</strong><br>
        Her ayƒ±n 14'√º kayƒ±t sildirme i√ßin son g√ºnd√ºr. Bu tarihler sonrasƒ±nda yapƒ±lan kayƒ±t sildirmelerde yeni d√∂nem √ºcreti tahsil edilir. Kul√ºbe veya kul√ºp tesislerine zarar verici davranƒ±≈ülarda bulunulmasƒ± durumunda kul√ºp √ºyeliƒüi sonlandƒ±rƒ±labilir.</p>
        ${generatePaymentTableForPdf(schedule)}`;

        const part3 = `<p>1) Daim√Æ Hastalƒ±k<br>
        √úyenin, √ºyelik s√ºresi i√ßerisinde derslere gelmesini veya derslerdeki aktivitelere katƒ±lmasƒ±nƒ± engelleyecek daim√Æ bir hastalƒ±ƒüa tutulmasƒ± ve bu durumun tam te≈üekk√ºll√º devlet hastanesinden alƒ±nmƒ±≈ü heyet raporu ile belgelenmesi halinde √ºyelik iptal edilir. √úyenin √ºyelik √ºcretinin tamamƒ±nƒ± √∂demi≈ü olmasƒ± durumunda, kullanƒ±lmayan s√ºreye ait √∂denen √ºcretten %.10kesinti yapƒ±larak, kalan tutar faizsiz olarak √úye/Veliye iade edilir. Kullanƒ±lan hizmet s√ºresinin bedeli iade olunmaz. √úye/Veli, bu madde gereƒüince i≈ülem yapƒ±labilmesi i√ßin, hastalƒ±ƒüa ili≈ükin raporunu √ºst yazƒ± ile birlikte Eƒüitmene verecektir. Hastalƒ±ƒüa ili≈ükin raporun, rapor tarihinden itibaren en ge√ß 10 g√ºn i√ßerisinde verilmesi gerekmektedir. Ge√ß verilen rapor ve dile√ßeler i≈ülem g√∂rmeyecek, ge√ßersiz kabul edilecektir.</p>
        <p>2) Eƒüitmenin Tek Taraflƒ± Fesih Hakkƒ±<br>
        Eƒüitmen taraflar arasƒ±ndaki i≈übu s√∂zle≈ümeyi her zaman 5 g√ºn √∂nceden bildirimde bulunmak kaydƒ±yla herhangi bir gerek√ße g√∂stermeksizin tek taraflƒ± olarak feshedebilir.</p>
        <p>√úye/Veli, i≈übu s√∂zle≈ümeyi imzalayarak bu maddeyi pe≈üinen kabul etmi≈ü sayƒ±lƒ±r. Bu durumda Eƒüitmen √úyenin kullanƒ±lmayan s√ºreye ili≈ükin √úyelik √ºcretini √∂demi≈ü olmasƒ± durumunda, √∂demi≈ü olduƒüu √ºcreti faizsiz olarak 5 g√ºn i√ßerisinde √úye/Veliye iade edecektir.</p>
        <p>Ayrƒ±ca Eƒüitmen haklƒ± bir nedenin varlƒ±ƒüƒ± halinde s√∂zle≈ümeyi herhangi bir s√ºre olmaksƒ±zƒ±n derhal tek taraflƒ± olarak da feshedebilir. Bu durumda, √ºyenin √ºyelik √ºcretinin kullanƒ±lmayan kƒ±smƒ± iade edilmez.</p>
        <p><strong>7-) Eƒûƒ∞Tƒ∞ME ƒ∞Lƒ∞≈ûKƒ∞N KURALLAR</strong><br>
        A) √úyelik ≈ûartlarƒ± ile √úye/Velinin Hak ve Y√ºk√ºml√ºl√ºkleri<br>
        1) Eƒüitmen, her t√ºrl√º √ºyelik talebini hi√ßbir gerek√ße g√∂stermeksizin tek taraflƒ± olarak reddetme hakkƒ±na sahiptir.<br>
        2) Eƒüitmenden, su√ß i≈ülememi≈ü ve herhangi bir y√ºz kƒ±zartƒ±cƒ± su√ßtan sabƒ±ka kaydƒ± bulunmayan T.C. vatanda≈ülarƒ± ile yabancƒ± uyruklu ki≈üiler ders alabilir. Eƒüitmenin bu hususa ili≈ükin adli sicil belgesi (sabƒ±ka kaydƒ±) talep etme ve deƒüerlendirme hakkƒ± saklƒ±dƒ±r.<br>
        3) Eƒüitmen √úye/Veliden, bula≈üƒ±cƒ± hastalƒ±klar gibi toplumu veya diƒüer √úye/Velilerin saƒülƒ±ƒüƒ±nƒ± tehlikeye d√º≈ü√ºrebilecek bir hastalƒ±ƒüƒ±nƒ±n bulunmadƒ±ƒüƒ±na dair saƒülƒ±k raporu ya da tahlil sonucu talep edebilir. S√∂z konusu tahliller sonucunda bula≈üƒ±cƒ± hastalƒ±k ve benzeri bir bulguya rastlanmasƒ± halinde Eƒüitmen, √úyeliƒüi yapacaƒüƒ± bir fesih bildirimi ile sona erdirme hakkƒ±na haizdir.</p>
        <p>4) √úye/Veli, √ºyelik i√ßin gerekli olan her t√ºrl√º belgeyi eksiksiz ve doƒüru bir ≈üekilde temin edecek; √ºyelik onayƒ± i√ßin ve/veya √ºyeliƒüin devamƒ± sƒ±rasƒ±nda Eƒüitmen tarafƒ±ndan talep edilecek her t√ºrl√º bilgi, belge, rapor vb. hususlarƒ± derhal temin ederek Eƒüitmene ibraz edecektir.</p>
        <p>5) √úyelerin spor faaliyetine katƒ±lmak i√ßin gerekli saƒülƒ±k ≈üartlarƒ±nƒ± ta≈üƒ±yƒ±p ta≈üƒ±madƒ±klarƒ±, spor aktivitesine uygun olup olmadƒ±klarƒ±, tƒ±bbi kontrollerini yaptƒ±rƒ±p yaptƒ±rmadƒ±klarƒ± veya saƒülƒ±k danƒ±≈ümanlarƒ±nƒ±n yaptƒ±ƒüƒ± tƒ±bbi tavsiyelerden ya da bunlarƒ±n neticelerinden dolayƒ± Eƒüitmenin herhangi bir sorumluluƒüu bulunmamaktadƒ±r. √úye/Veli, √ºyelik s√∂zle≈ümesini imzaladƒ±ƒüƒ± andan itibaren; saƒülƒ±k durumunun spor yapmaya elveri≈üli olduƒüunu, spor faaliyetine katƒ±lmasƒ±na engel bir √∂zr√º ve rahatsƒ±zlƒ±ƒüƒ±nƒ±n bulunmadƒ±ƒüƒ±nƒ±, faaliyete katƒ±lmasƒ±nƒ±n saƒülƒ±ƒüƒ±na ve fiziksel durumuna bir zarar vermeyeceƒüini beyan ve taahh√ºt etmi≈ütir.</p>`;
        
        const part4 = `<p>6) √úyelerin, ders veya aktivitelerden faydalanmamalarƒ± halinde dahi belirlenen bedelleri zamanƒ±nda ve tam olarak √∂demeleri zorunludur. √úyelerin yapƒ±lacak aktivitelerden veya verilecek derslerden yararlanmamalarƒ± hi√ßbir ≈üekil ve ≈üartta √úye/Veliye √ºyelik bedelini √∂dememe hakkƒ± vermemektedir. √úye derslerden yararlanmasa dahi √úyelika bedellerini √∂demek zorundadƒ±r.</p>
        <p>7) √úye/Veli, kendisinin veya misafirlerinin ≈üahsi kusurlarƒ±, dikkatsizliƒüi veya ihmalleri ile; kul√ºbe veya 3. Ki≈üilere ait e≈üyalar √ºzerinde meydana getirecekleri t√ºm hasar ve zarardan ve yine diƒüer √úye/Velilerin yahut Eƒüitmen √ßalƒ±≈üanlarƒ±nƒ±n ve 3. ki≈üilerin uƒüramƒ±≈ü olduƒüu t√ºm zarar ve kayƒ±plardan sorumludur.</p>
        <p>B) KUL√úP KURALLARI<br>
        a) Grup dersleri aylƒ±k 8 derstir.<br>
        b) Grup derslerinde ders bir kez i≈ülendiƒüinden, √ºyenin katƒ±lamadƒ±ƒüƒ± dersler i√ßin telafi yapƒ±lmaz.<br>
        c) √ñzel ders paketleri 1 aylƒ±k s√ºreyle ge√ßerlidir. Bu s√ºre i√ßinde kullanƒ±lmayan ders haklarƒ± bir sonraki aya devredilmez.<br>
        d) Spor bran≈ülarƒ±nda herhangi bir kaza, yaralanma veya saƒülƒ±k problemi durumunda sorumluluk tamamen √úye/Veliye aittir.<br>
        e) Kayƒ±t sildirme i≈ülemi yapƒ±ldƒ±ƒüƒ±nda sistem √ºzerinden t√ºm ki≈üisel verileriniz ve kayƒ±t bilgileriniz silinir.<br>
        f) √úyelerin derse zamanƒ±nda, uygun kƒ±yafetle ve hazƒ±r ≈üekilde gelmesi √úye/Velilerin sorumluluƒüundadƒ±r.<br>
        g) Kayƒ±t silme talebinde bulunan √∂ƒürencinin kalan dersleri mevcut d√∂nem tarihleri i√ßerisinde yapƒ±lƒ±r.</p>
        <p>C) GENEL KURALLAR<br>
        1) Kul√ºp b√ºnyesinde √úye/Veliler genel nezaket kurallarƒ±na uymakla y√ºk√ºml√ºd√ºrler. Kort i√ßinde veya dƒ±≈üƒ±nda nezaket kurallarƒ±na uymayan davranƒ±≈ülarda bulunan, huzuru ka√ßƒ±ran, hakaret, k√ºf√ºr kullanan √úye/Velilerin √úye/Velilikleri herhangi bir uyarƒ±ya gerek kalmadan resen iptal edilebilir. Bu takdirde √úye/Velilik bedelleri kƒ±smen dahi geri √∂denmez.<br>
        2) Kayƒ±p e≈üyalardan Kul√ºp sorumlu deƒüildir.<br>
        3) √úye/Veli ruhsatlƒ± bile olsa Kul√ºp'e delici, kesici ve patlayƒ±cƒ± alet veya silahla giremez. Aksi hallerde √úye/Veli Kul√ºp'e giremeyecektir.<br>
        4) √úye/Velinin Kapalƒ± alanlarda ve Kul√ºp tarafƒ±ndan yasaklanan alanlarda sigara i√ßmesi kesinlikle yasaktƒ±r.<br>
        5) Kul√ºp i√ßine dƒ±≈üarƒ±dan yiyecek i√ßecek getirmek yasaktƒ±r.<br>
        6) Soyunma odalarƒ±ndaki dolaplar g√ºnl√ºk kullanƒ±m i√ßindir. √úye/Velinin tek dolap kullanƒ±m hakkƒ± vardƒ±r.<br>
        7) √úye/Veliler, t√ºm e≈üyalarƒ±nƒ± dolap i√ßine koymalƒ±, dolap kapaklarƒ±na ve/veya dƒ±≈üƒ±na herhangi bir e≈üya asmamalƒ± ve dolaplarƒ±nƒ± kilitlemelidirler. Dolaplar kullanƒ±m sonrasƒ± tamamen bo≈üaltƒ±lmalƒ±dƒ±r.<br>
        8) Dolap i√ßinde cep telefonlarƒ± sessiz konumda bƒ±rakƒ±lmalƒ±dƒ±r.</p>
        <p>9) G√ºnl√ºk dolaplar kullanƒ±m sonrasƒ± bo≈ü ve a√ßƒ±k olarak bƒ±rakƒ±lmalƒ±dƒ±r. Kul√ºp, hijyen ve g√ºvenlik nedenleri ile g√ºn sonunda kilitli dolaplarƒ± g√∂revli y√∂netici e≈üliƒüinde a√ßma ve i√ßindeki e≈üyalarƒ± bo≈üaltma hakkƒ±na sahiptir. Dolapta bƒ±rakƒ±lan e≈üyanƒ±n kaybolmasƒ±ndan veya hasarƒ±ndan Kul√ºp sorumlu tutulamaz.</p>
        <p>10) Soyunma odalarƒ±nda g√∂r√ºnt√º/ses kaydƒ± yapƒ±lmasƒ± kesinlikle yasaktƒ±r. Aksi davranƒ±≈üta bulunanlarƒ±n tespiti halinde, Kul√ºp tarafƒ±ndan her t√ºrl√º hak saklƒ± tutulmak kaydƒ± ile √úye/Velilik feshi h√ºk√ºmleri uygulanabilecektir. √úye/Veli, soyunma odalarƒ±nda ger√ßekle≈ütirilen g√∂r√ºnt√º/ses kaydƒ±nƒ±n sonu√ßlarƒ±ndan Kul√ºp'√ºn hi√ßbir sorumluluƒüu olmadƒ±ƒüƒ±nƒ± kabul, beyan ve taahh√ºt eder.</p>
        <p>11) Soyunma odalarƒ±nda √∂zel ve deƒüerli e≈üya bƒ±rakƒ±lmamalƒ±dƒ±r. Bƒ±rakƒ±lan e≈üyalarƒ±n kaybolmasƒ±ndan veya hasarƒ±ndan Kul√ºp sorumlu tutulamaz.</p>`;

        const part5 = `<p>12) Kul√ºp, sunduƒüu hizmetler ve √ßalƒ±≈ümalar ile ilgili kurallar ve uygulamalarda, zaman ve ihtiyaca baƒülƒ± deƒüi≈üiklikler yapabilir, yeni maddeler ilave edebilir. Olabilecek b√ºt√ºn deƒüi≈üiklikler √úye/Velilere bildirilir.</p>
        <p>13) Tesisin t√ºm alanlarƒ±nda √úye/Velilerin hijyeni, saƒülƒ±ƒüƒ± ve g√ºvenliƒüi d√º≈ü√ºn√ºlerek hazƒ±rlanan prosed√ºr ve kullanƒ±m kurallarƒ±na uyulmasƒ± zorunludur.</p>
        <p>14) Kul√ºp sƒ±nƒ±rlarƒ± i√ßerisinde (a√ßƒ±k ve kapalƒ± alan fark etmeksizin) sigara i√ßmek yasaktƒ±r.</p>
        <p><strong>8- Kƒ∞≈ûƒ∞SEL VE √ñZEL Nƒ∞TELƒ∞KLƒ∞ Kƒ∞≈ûƒ∞SEL VERƒ∞LERƒ∞N ƒ∞≈ûLENMESƒ∞</strong><br>
        √úye/Veli, i≈übu s√∂zle≈ümeye taraf olma suretiyle, verdiƒüi t√ºm bilgilerin ve/veya √úye/Velilik ili≈ükisinin devamƒ±na herhangi bir suretle Kul√ºp'e verdiƒüi t√ºm ki≈üisel bilgilerinin, saƒülƒ±k ge√ßmi≈üi bilgilerinin, √úye/Velilik s√ºresince elde edilen ki≈üisel ve √∂zel nitelikli ki≈üisel verilerinin, √úye/Velilik bedelinin √∂denmesiyle baƒülantƒ±lƒ± olarak elektronik ve diƒüer ortamlarda verilen/verilecek bilgilerin, "Veri Sorumlusu" sƒ±fatƒ±yla Kul√ºp tarafƒ±ndan ve Kul√ºp ortaklarƒ±, i≈ü ortaklarƒ±, halefleri ve/veya bunlarƒ±n belirleyeceƒüi √º√ß√ºnc√º ki≈üiler tarafƒ±ndan, mezkur verilerin gizliliklerinin korunmasƒ± i√ßin gerekli tedbirleri almak ve ki≈üisel verilerin i≈ülenmesine dair kanuni ilkelere uymak suretiyle otomatik olan/olmayan y√∂ntemler ile alƒ±nmasƒ±na, devralƒ±nmasƒ±na, yasal s√ºreler a≈üƒ±lmamak √ºzere yurt i√ßinde ve/veya yurt dƒ±≈üƒ±nda yazƒ±lƒ±/dijital ar≈üivlere kaydedilmesine, depolanmasƒ±na, muhafaza edilmesine, elde edilebilir hale getirilmesine, kullanƒ±lmasƒ±na, g√ºncellenmesine, deƒüi≈ütirilmesine, yeniden d√ºzenlenmesine, sƒ±nƒ±flandƒ±rƒ±lmasƒ±na, yurt i√ßinde veya yurt dƒ±≈üƒ±na aktarƒ±lmasƒ±na ve sair kanunlara uygun ≈üekilde herhangi bir suretle i≈ülenmesine, bu hususta Kul√ºp tarafƒ±ndan √ße≈üitli mecralar √ºzerinden aydƒ±nlatƒ±lmƒ±≈ü ve yasal haklarƒ± hakkƒ±nda bilgilindirilmi≈ü olarak a√ßƒ±k√ßa izin(rƒ±za/onay) verdiƒüini kabul, beyan ve taahh√ºt eder.</p>
        <p>1. Veri Sorumlusu:<br>${club.contactName}<br>${club.address}<br>${club.phone}<br>${club.email}</p>
        <p>2. Ki≈üisel Verilerin ƒ∞≈ülenme Ama√ßlarƒ±:<br>Ki≈üisel verileriniz; √úye/Velilik i≈ülemleri, spor etkinliklerine katƒ±lƒ±m y√∂netimi, ileti≈üim faaliyetleri, g√ºvenlik kayƒ±tlarƒ±nƒ±n tutulmasƒ±, kul√ºp i√ßi bilgilendirme ve organizasyon ama√ßlarƒ±yla i≈ülenmektedir. Ayrƒ±ca yasal y√ºk√ºml√ºl√ºklerimizi yerine getirmek, hukuki taleplere yanƒ±t vermek ve sizinle ileti≈üim kurmak amacƒ±yla da kullanƒ±lmaktadƒ±r.</p>
        <p>3. Toplanan Ki≈üisel Veriler:<br>Ad, soyad, ileti≈üim bilgileri, doƒüum tarihi, spor etkinliklerine ili≈ükin bilgiler gibi ki≈üisel veriler toplanmaktadƒ±r.</p>
        <p>4. Ki≈üisel Verilerin ƒ∞≈ülenme Hukuki Sebepleri:<br>Verileriniz, KVKK'nƒ±n 5. ve 6. maddeleri kapsamƒ±nda; a√ßƒ±k rƒ±za, s√∂zle≈ümenin kurulmasƒ± veya ifasƒ±, yasal y√ºk√ºml√ºl√ºklerin yerine getirilmesi, haklarƒ±n tesisi, kullanƒ±lmasƒ± veya korunmasƒ± gibi hukuki sebepler doƒürƒüultusunda i≈ülenmektedir.</p>
        <p>5. Ki≈üisel Verilerin Saklama S√ºresi:<br>Ki≈üisel verileriniz, i≈ülenme amacƒ±nƒ±n gerektirdiƒüi s√ºre boyunca saklanacak, bu s√ºrenin sonunda silinecek veya anonim hale getirilecektir.</p>
        <p>6. Ki≈üisel Veri Sahiplerinin Haklarƒ±:<br>KVKK uyarƒ±nca veri sahipleri;<br>‚Ä¢ Ki≈üisel verilerinin i≈ülenip i≈ülenmediƒüini √∂ƒürenme,<br>‚Ä¢ ƒ∞≈ülenmi≈üse buna ili≈ükin bilgi talep etme,<br>‚Ä¢ ƒ∞≈üleme amacƒ±nƒ± ve amaca uygun kullanƒ±lƒ±p kullanƒ±lmadƒ±ƒüƒ±nƒ± √∂ƒürenme,<br>‚Ä¢ Verilerin aktarƒ±ldƒ±ƒüƒ± √º√ß√ºnc√º ki≈üileri bilme,<br>‚Ä¢ Eksik veya yanlƒ±≈ü i≈ülenmi≈ü verilerin d√ºzeltilmesini isteme,<br>‚Ä¢ Verilerin silinmesini veya yok edilmesini talep etme,<br>‚Ä¢ Bu i≈ülemlerin √º√ß√ºnc√º ki≈üilere bildirilmesini isteme,<br>‚Ä¢ Otomatik sistemlerle analiz sonucu aleyhe √ßƒ±kan sonu√ßlara itraz etme hakkƒ±na sahiptir.</p>`;
        
        const part6 = `<p><strong>9-) SON H√úK√úMLER</strong><br>
        1) Bu anla≈ümanƒ±n uygulanmasƒ±ndan kaynaklanan t√ºm ihtilaflarda Samsun mahkemeleri ve icra daireleri yetkilidir.</p>
        <p>2) Taraflarƒ±n s√∂zle≈ümenin giri≈üinde unvanlarƒ± altƒ±nda adresler s√∂zle≈üme uyarƒ±nca kanuni tebligat adresleri olarak kabul edilecek ve bu adreslere yapƒ±lan tebligatlar kendilerine yapƒ±lmƒ±≈ü sayƒ±lacaktƒ±r. Taraflardan biri adresinde meydana gelen deƒüi≈üikliƒüi 5 (be≈ü) g√ºn i√ßerisinde diƒüer tarafa bildirmediƒüi takdirde yukarƒ±daki yer alan adreslere Tebligat Kanunu h√ºk√ºmleri dahilinde yapƒ±lacak ihbar ve tebligat muteber olacaktƒ±r.</p>
        <p>3)√úye/Veli, cep telefonu ve/veya e-mail adres deƒüi≈üikliƒüini yazƒ±lƒ± olarak Eƒüitmene bildirmediƒüi takdirde, bildirmi≈ü olduƒüu cep telefonu ve/veya e-posta adresine yapƒ±lacak bildirimlerin ge√ßerli olacaƒüƒ±nƒ± ve kendisine tebligatƒ±n yapƒ±lmƒ±≈ü sayƒ±lacaƒüƒ±nƒ± kabul, beyan ve taahh√ºt eder. ƒ∞≈übu √ºyelik nedeniyle yapƒ±lacak her t√ºrl√º bildirim, s√∂zle≈ümenin kabul√º sƒ±rasƒ±nda, √ºye tarafƒ±ndan bildirilen cep telefonu ve/veya e posta adresine g√∂nderilecek mesaj aracƒ±lƒ±ƒüƒ± ile saƒülanacaktƒ±r.</p>
        <p>√úYE/VELƒ∞ Eƒûƒ∞TMEN<br>
        -Re≈üit olmayan katƒ±lƒ±mcƒ±larƒ±n velileri veya vasileri i√ßin √úye, i≈übu belge ile a≈üaƒüƒ±da adƒ± ge√ßen katƒ±lƒ±mcƒ± i√ßin yasal sorumluluƒüu olan bir veli/vasi olarak, yukarƒ±da belirtilen ≈üekilde ≈üahsƒ±n ibrasƒ±na muvafakat ettiƒüini ve ibrayƒ± kabul ettiƒüini beyan eder. Ya≈üƒ± k√º√ß√ºk √ßocuƒüunun saƒülanan programlara katƒ±lƒ±mƒ± veya programlarla ili≈ükisi nedeniyle meydana gelen her t√ºrl√º sorumluluk doƒüuran olaylardan dolayƒ± Kul√ºp'√º, sahibini, ortaklarƒ±nƒ± ve √ßalƒ±≈üanlarƒ±nƒ± sorumlu tutmayacaƒüƒ±nƒ± taahh√ºt eder.</p>
        ${isChild ? `<p>Re≈üit Olmayanƒ±n Adƒ± ve Soyadƒ±: ${data.Resit_Olmayan_Adi_Soyadi}<br>
        Re≈üit Olmayanƒ±n Doƒüum Tarihi: ${formatDate(data.Resit_Olmayan_Dogum_Tarihi)}<br>
        Velisinin/Vasisinin Adƒ± ve Soyadƒ±: ${data.Ad_Soyad}</p>` : ''}`;

        return [part1, part2, part3, part4, part5, part6];
    };


    // --- FORM NAVIGATION ---
    const updateProgressBar = () => {
        const progressSteps = document.querySelectorAll('.progress-step');
        const progressLine = document.getElementById('progress-line');
        progressSteps.forEach((step, index) => {
            step.classList.toggle('active', index < currentStep);
        });
        progressLine.style.width = `${((currentStep - 1) / (totalSteps - 1)) * 100}%`;
    };

    const showStep = (stepNumber) => {
        steps.forEach(step => step.classList.remove('active'));
        document.getElementById(`step-${stepNumber}`).classList.add('active');
        currentStep = stepNumber;
        updateProgressBar();
        
        prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
        nextBtn.style.display = currentStep < totalSteps ? 'inline-flex' : 'none';
        submitBtn.style.display = currentStep === totalSteps ? 'inline-flex' : 'none';
    };
    
    // --- ADVANCE LOGIC ---
    async function attemptAdvanceFromStep1() {
        if (nextBtn.disabled) return; 

        const phoneInput = document.getElementById('phone');
        const phone = phoneInput.value;
        const branch = document.getElementById('branchSelection').value;

        if (phone.length !== 11 || !branch) {
            return; 
        }
        
        const phoneRegex = /^0[0-9]{10}$/;
        if (!phoneRegex.test(phone)) {
            return showAlert(phoneInput.title, 'danger', 'step-1');
        }

        nextBtn.disabled = true;
        nextBtn.textContent = 'Kontrol ediliyor...';
        try {
            const found = await checkPreRegistration(branch, phone);
            if (found) {
                showStep(currentStep + 1);
            }
        } finally {
            nextBtn.disabled = false;
            nextBtn.textContent = 'ƒ∞leri';
        }
    }

    document.getElementById('phone').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        attemptAdvanceFromStep1();
    });

    document.getElementById('branchSelection').addEventListener('change', attemptAdvanceFromStep1);

    nextBtn.addEventListener("click", async () => {
        if (currentStep === 1) {
            const phoneInput = document.getElementById('phone');
            const phone = phoneInput.value;
            const branch = document.getElementById('branchSelection').value;
            if (!branch || !phone) {
                return showAlert('L√ºtfen bran≈ü se√ßin ve telefon numaranƒ±zƒ± girin.', 'danger', 'step-1');
            }
            await attemptAdvanceFromStep1();
        } else if (currentStep === 3) {
             const isMinor = currentPreRegistration.studentName && currentPreRegistration.parentName;
             if(isMinor && (!document.getElementById('minorFullName').value || !document.getElementById('minorDob').value)) {
                 return showAlert('L√ºtfen √∂ƒürenci adƒ±nƒ± ve doƒüum tarihini girin.', 'danger', 'step-3');
             }
             if(!document.getElementById('tcno').value || !document.getElementById('address').value) {
                  return showAlert('L√ºtfen T.C. Kimlik No ve Adres alanlarƒ±nƒ± doldurun.', 'danger', 'step-3');
             }
             populateContractText();
             showStep(currentStep + 1);
        }
        else if (currentStep < totalSteps) {
            showStep(currentStep + 1);
        }
    });

    prevBtn.addEventListener("click", () => {
        if (currentStep > 1) showStep(currentStep - 1);
    });

    // --- PRE-REGISTRATION LOGIC ---
    async function checkPreRegistration(branch, phone) {
        if (!window.firebase || !window.db) return false;
        const notFoundDiv = document.getElementById('pre-reg-not-found');
        
        try {
            const q = window.firebase.query(
                window.firebase.collection(window.db, 'preRegistrations'),
                window.firebase.where('phone', '==', phone)
            );
            const querySnapshot = await window.firebase.getDocs(q);

            if (querySnapshot.empty) {
                notFoundDiv.style.display = 'block';
                currentPreRegistration = null;
                return false;
            }

            const matchingDoc = querySnapshot.docs.find(doc => {
                const data = doc.data();
                return data.branch === branch && data.status === 'pending_contract';
            });

            if (!matchingDoc) {
                notFoundDiv.style.display = 'block';
                currentPreRegistration = null;
                return false;
            }
            
            currentPreRegistration = { id: matchingDoc.id, ...matchingDoc.data() };
            
            notFoundDiv.style.display = 'none';
            populateFormWithPreRegData();
            return true;

        } catch (error) {
            console.error("Error checking pre-registration:", error);
            showAlert("Kayƒ±t kontrol edilirken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.", "danger", "step-1");
            return false;
        }
    }

    function populateFormWithPreRegData() {
        const preReg = currentPreRegistration;
        const club = clubData[preReg.branch] || { name: 'Atakum Tenis Kul√ºb√º - Mafen Spor Kul√ºb√º' };
        document.getElementById('clubNameHeader').textContent = club.name;
        document.getElementById('paymentPlanContainer').style.display = 'block';
        document.getElementById('paymentPlanContainer').innerHTML = generatePaymentPlanHtml(preReg);
        
        const isChild = !!(preReg.parentName && preReg.studentName);
        document.getElementById('fullName').value = preReg.parentName || preReg.studentName;
        
        const minorFieldsDiv = document.getElementById('minorFields');
        const minorNameInput = document.getElementById('minorFullName');
        const minorDobInput = document.getElementById('minorDob');
        
        if (isChild) {
            minorFieldsDiv.style.display = 'block';
            minorNameInput.value = preReg.studentName;
            minorNameInput.required = true;
            minorDobInput.value = preReg.studentBirthDate || '';
            minorDobInput.required = true;
        } else {
            minorFieldsDiv.style.display = 'none';
            minorNameInput.required = false;
            minorDobInput.required = false;
        }
    }
    
    function populateContractText() {
        const contractData = {
            Ad_Soyad: document.getElementById('fullName').value,
            TC_Kimlik_No: document.getElementById('tcno').value,
            Telefon: document.getElementById('phone').value,
            Adres: document.getElementById('address').value,
            Resit_Olmayan_Adi_Soyadi: document.getElementById('minorFullName').value,
            Resit_Olmayan_Dogum_Tarihi: document.getElementById('minorDob').value
        };
        const club = clubData[currentPreRegistration.branch];
        const contractSections = getContractSections(club, contractData, currentPreRegistration.paymentSchedule);
        document.getElementById('contractTextArea').innerHTML = contractSections.join('<hr style="margin: 20px 0;">');
    }

    function generatePaymentPlanHtml(preReg) {
       let infoHtml = '';
       if (preReg.studentName && preReg.parentName) { // √áocuk kaydƒ±
           infoHtml = `
                <p><strong>Veli:</strong> ${preReg.parentName}</p>
                <p><strong>√ñƒürenci:</strong> ${preReg.studentName}</p>`;
       } else { // Yeti≈ükin kaydƒ±
           infoHtml = `<p><strong>√úye:</strong> ${preReg.studentName || preReg.parentName}</p>`;
       }

       let planHtml = `${infoHtml}
            <h5 style="margin-top: 15px;">üìÖ Aidat Bilgileriniz:</h5>
            <p style="font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">√úyeliƒüiniz iptal edilene kadar devam etmektedir. Her ayƒ±n 14‚Äô√º, yeni d√∂nem i√ßin kayƒ±t iptali yapƒ±labilecek son g√ºnd√ºr. Bu tarihe kadar iptal edilmeyen kayƒ±tlar, devam eden d√∂nem i√ßin ge√ßerli sayƒ±lƒ±r.</p>
            <div class="payment-schedule">`;

        if (preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
            preReg.paymentSchedule.forEach(p => {
                planHtml += `<div class="payment-item-preview">
                    <div>
                        <strong>${p.paymentNumber}. Aidat</strong> (${p.period.lessonCount || 'N/A'} Ders)<br>
                        <small>D√∂nem: ${formatDate(p.period.start)} - ${formatDate(p.period.end)}</small><br>
                        <small>Son √ñdeme Tarihi: ${formatDate(p.dueDate)}</small>
                    </div>
                    <span>${p.amount}‚Ç∫</span>
                </div>`;
            });
        }
        planHtml += '</div>';
        return planHtml;
    }

    // --- SIGNATURE CANVAS ---
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let hasSignature = false;
    function resizeCanvas(){const p=canvas.parentElement;canvas.width=Math.min(400,p.clientWidth-60);canvas.height=200;ctx.strokeStyle="#343a40";ctx.lineWidth=2;ctx.lineCap="round"}window.addEventListener("resize",resizeCanvas);resizeCanvas();let isDrawing=!1;const getCoords=e=>{const t=canvas.getBoundingClientRect(),a=e.touches?e.touches[0]:null;return{x:(a?a.clientX:e.clientX)-t.left,y:(a?a.clientY:e.clientY)-t.top}},startDrawing=e=>{e.preventDefault(),isDrawing=!0,hasSignature=!0;const{x:t,y:a}=getCoords(e);ctx.beginPath(),ctx.moveTo(t,a)},draw=e=>{if(!isDrawing)return;e.preventDefault();const{x:t,y:a}=getCoords(e);ctx.lineTo(t,a),ctx.stroke()},stopDrawing=()=>{isDrawing=!1};canvas.addEventListener("mousedown",startDrawing),canvas.addEventListener("mousemove",draw),canvas.addEventListener("mouseup",stopDrawing),canvas.addEventListener("mouseout",stopDrawing),canvas.addEventListener("touchstart",startDrawing),canvas.addEventListener("touchmove",draw),canvas.addEventListener("touchend",stopDrawing);function clearSignature(){ctx.clearRect(0,0,canvas.width,canvas.height),hasSignature=!1}
    
    // --- FORM SUBMISSION & PDF ---
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (!hasSignature) return showAlert('L√ºtfen s√∂zle≈ümeyi imzalayƒ±n.', 'danger', 'step-4');
        if (!currentPreRegistration) return showAlert('Ge√ßerli bir √∂n kayƒ±t bulunamadƒ±.', 'danger', 'step-4');
        if (!document.getElementById('agreeContract').checked || !document.getElementById('cancellationPolicyNew').checked) {
            return showAlert('L√ºtfen t√ºm s√∂zle≈üme ve iptal ko≈üullarƒ±nƒ± onaylayƒ±n.', 'danger', 'step-4');
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒ∞≈üleniyor...';

        try {
            const formData = Object.fromEntries(new FormData(form).entries());
            formData.Telefon = document.getElementById('phone').value;
            formData.signature = canvas.toDataURL('image/png');
            formData.timestamp = new Date().toISOString();

            // 1. Create and download PDF
            const pdfDoc = await createPdf(formData);
            await pdfDoc.save(`${formData.Ad_Soyad.replace(/\s+/g, '_')}_sozlesme.pdf`);
            
            // 2. Update Member Record in Firebase
            const memberQuery = window.firebase.query(
                window.firebase.collection(window.db, 'members'),
                window.firebase.where('preRegistrationId', '==', currentPreRegistration.id)
            );
            const querySnapshot = await window.firebase.getDocs(memberQuery);
            
            if (!querySnapshot.empty) {
                const memberDocRef = querySnapshot.docs[0].ref;
                await window.firebase.updateDoc(memberDocRef, { 
                    status: 'active',
                    TC_Kimlik_No: formData.TC_Kimlik_No,
                    Adres: formData.Adres,
                    signature: formData.signature 
                });
            } else {
                 throw new Error("ƒ∞li≈ükili √ºye kaydƒ± bulunamadƒ±. L√ºtfen y√∂netici ile ileti≈üime ge√ßin.");
            }

            // 3. Update Pre-registration Status
            await window.firebase.updateDoc(
                window.firebase.doc(window.db, 'preRegistrations', currentPreRegistration.id),
                { status: 'completed', completedAt: new Date().toISOString() }
            );
            
            // 4. Show Success
            document.getElementById('progress-bar').style.display = 'none';
            steps.forEach(step => step.style.display = 'none');
            document.querySelector('.form-navigation').style.display = 'none';
            document.getElementById('successMessage').style.display = 'flex';

        } catch (error) {
            console.error("Submission error:", error);
            showAlert("Bir hata olu≈ütu: " + error.message, "danger", "step-4");
            submitBtn.disabled = false;
            submitBtn.textContent = 'S√∂zle≈ümeyi Onayla';
        }
    });
    
    async function createPdf(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const club = clubData[currentPreRegistration.branch];
        const contractParts = getContractSections(club, data, currentPreRegistration.paymentSchedule);

        for (let i = 0; i < contractParts.length; i++) {
            if (i > 0) doc.addPage();
            
            const pageHtml = generatePageHtml(data, club, contractParts[i], i + 1, contractParts.length);
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '595px'; // A4 width in points
            tempContainer.innerHTML = pageHtml;
            document.body.appendChild(tempContainer);
            
            const pageCanvas = await html2canvas(tempContainer, { scale: 2 });
            document.body.removeChild(tempContainer);
            
            const imgData = pageCanvas.toDataURL('image/jpeg', 0.9);
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
        }
        return doc;
    }

    function generatePageHtml(d, club, pageContent, pageNum, totalPages) {
        const headerTitle = document.getElementById('clubNameHeader').textContent;
        return `
        <!DOCTYPE html><html><head><meta charset="UTF-8"><style>
            body { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 10px; line-height: 1.4; color: #333; width: 595px; }
            .pdf-page { padding: 40px; display: flex; flex-direction: column; height: 842px; /* A4 height in points */ box-sizing: border-box; }
            h1 { font-size: 18px; text-align: center; } h4 { font-size: 12px; margin-top: 15px; }
            .content { flex-grow: 1; }
            .footer { text-align: center; font-size: 9px; color: #888; border-top: 1px solid #ccc; padding-top: 10px; margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; }
            .signature-box img { width: 100px; height: 50px; }
            .signature-box p { margin: 0; font-size: 8px; }
        </style></head><body>
            <div class="pdf-page">
                <h1>${headerTitle} √úyelik S√∂zle≈ümesi</h1>
                <div class="content">${pageContent}</div>
                <div class="footer">
                    <div class="signature-box">
                        <img src="${d.signature}" />
                        <p><strong>${d.Ad_Soyad}</strong></p>
                        <p>${new Date(d.timestamp).toLocaleString('tr-TR')}</p>
                    </div>
                    <div>Sayfa ${pageNum} / ${totalPages}</div>
                </div>
            </div>
        </body></html>`;
    }

    // --- HELPER FUNCTIONS ---
    function showAlert(message, type = 'danger', stepId) {
        const step = document.getElementById(stepId);
        if(!step) return;
        
        const existingAlert = step.querySelector('.alert-temp');
        if (existingAlert) existingAlert.remove();

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-temp`;
        alertDiv.textContent = message;
        step.insertBefore(alertDiv, step.firstChild);
        setTimeout(() => alertDiv.remove(), 5000);
    }
    function formatDate(dateString) {
        if (!dateString) return '';
        // Add T00:00:00 to handle potential timezone issues
        return new Date(dateString + 'T00:00:00').toLocaleDateString('tr-TR');
    }
    
    // Initial setup
    showStep(1);
</script>
</body>
</html>
